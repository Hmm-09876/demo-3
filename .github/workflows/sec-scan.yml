name: Security Scan
on: 
    workflow_run:
        workflows: ["CI"]
        types:
            - completed
            
permissions:
    contents: read
    packages: read

jobs: 
    trivy-scan:
        runs-on: ubuntu-latest
        env:
            IMAGE: ghcr.io/${{ github.repository_owner }}/${{ github.repository }}
        if: |
            ${{ github.event.workflow_run.conclusion == 'success' }}
            ${{ github.action == 'true' }}
        steps:
            - name: Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine Image Tag
              run: |
                echo "IMAGE=$( echo ${{ env.IMAGE }} | tr '[:upper:]' '[:lower:]' | tr '_' '-')" >> $GITHUB_ENV
                echo "IMAGE=${IMAGE}"
        
            - name: Pull Docker Image
              run: docker pull "${IMAGE}"

            - name: Run Trivy Scan
              uses: aquasecurity/trivy-action@master
              with:
                    image-ref: ${{ env.IMAGE }}
                    format: 'table'
                    exit-code: '1'
